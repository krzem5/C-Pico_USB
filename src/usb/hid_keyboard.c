#include <pico/time.h>
#include <usb/usb.h>



#define DEFAULT_INTERVAL 8



static const uint16_t _key_map[128]={
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x002a,
	0x002b,
	0x0028,
	0x0000,
	0x0000,
	0x0028,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x0029,
	0x0000,
	0x0000,
	0x0000,
	0x0000,
	0x002c,
	0x021e,
	0x0234,
	0x0220,
	0x0221,
	0x0222,
	0x0224,
	0x0034,
	0x0226,
	0x0227,
	0x0225,
	0x022e,
	0x0036,
	0x002d,
	0x0037,
	0x0038,
	0x0027,
	0x001e,
	0x001f,
	0x0020,
	0x0021,
	0x0022,
	0x0023,
	0x0024,
	0x0025,
	0x0026,
	0x0233,
	0x0033,
	0x0236,
	0x002e,
	0x0237,
	0x0238,
	0x021f,
	0x0204,
	0x0205,
	0x0206,
	0x0207,
	0x0208,
	0x0209,
	0x020a,
	0x020b,
	0x020c,
	0x020d,
	0x020e,
	0x020f,
	0x0210,
	0x0211,
	0x0212,
	0x0213,
	0x0214,
	0x0215,
	0x0216,
	0x0217,
	0x0218,
	0x0219,
	0x021a,
	0x021b,
	0x021c,
	0x021d,
	0x002f,
	0x0031,
	0x0030,
	0x0223,
	0x022d,
	0x0035,
	0x0004,
	0x0005,
	0x0006,
	0x0007,
	0x0008,
	0x0009,
	0x000a,
	0x000b,
	0x000c,
	0x000d,
	0x000e,
	0x000f,
	0x0010,
	0x0011,
	0x0012,
	0x0013,
	0x0014,
	0x0015,
	0x0016,
	0x0017,
	0x0018,
	0x0019,
	0x001a,
	0x001b,
	0x001c,
	0x001d,
	0x022f,
	0x0231,
	0x0230,
	0x0235,
	0x004c,
};



void usb_hid_keyboard_type_keys(uint8_t endpoint,const char* string,uint8_t interval){
	if (!interval){
		interval=DEFAULT_INTERVAL;
	}
	uint8_t buffer[8]={0,0,0,0,0,0,0,0};
	uint8_t mask=0;
	while (*string){
		uint8_t key=*string;
		string++;
		if (key>=0xf0){
			if (key&1){
				mask&=~(1<<((key>>1)&7));
			}
			else{
				mask|=1<<((key>>1)&7);
			}
			continue;
		}
		uint8_t new_mask=0;
		uint8_t new_key=0;
		if (key>>7){
			new_mask=0;
			new_key=key-78;
		}
		else{
			new_mask=mask|(_key_map[key]>>8);
			new_key=_key_map[key];
		}
		if (buffer[2]==new_key){
			buffer[0]=0;
			buffer[2]=0;
			usb_transfer(endpoint,buffer,8);
			busy_wait_ms(interval);
		}
		buffer[0]=new_mask;
		buffer[2]=new_key;
		usb_transfer(endpoint,buffer,8);
		busy_wait_ms(interval);
	}
	buffer[0]=0;
	buffer[2]=0;
	usb_transfer(endpoint,buffer,8);
	busy_wait_ms(interval);
}
